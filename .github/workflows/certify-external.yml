# Certify External Verus Projects
#
# This workflow allows BAIF to certify Verus projects outside the organization.
# It's triggered manually with a GitHub repository URL.
#
# The certification badge is hosted in THIS repo (certify), so external projects
# just need to add a badge URL pointing here - no write access required.

name: Certify External Project

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL (e.g., https://github.com/owner/repo)'
        required: true
        type: string
      project_path:
        description: 'Path to Verus project within repo (default: . for root)'
        required: false
        default: '.'
        type: string
      package:
        description: 'Package name for workspace projects (optional)'
        required: false
        default: ''
        type: string
      ref:
        description: 'Git ref to certify (branch, tag, or commit SHA)'
        required: false
        default: 'main'
        type: string
      network:
        description: 'Ethereum network for certification'
        required: false
        default: 'mainnet'
        type: choice
        options:
          - mainnet
          - sepolia

permissions:
  contents: write  # To update certifications directory

jobs:
  certify-external:
    runs-on: ubuntu-latest
    steps:
      - name: Parse repository info
        id: repo
        run: |
          REPO_URL="${{ inputs.repo_url }}"
          
          # Extract owner/repo from URL
          # Handles: https://github.com/owner/repo or https://github.com/owner/repo.git
          REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https://github.com/||' | sed 's|\.git$||' | sed 's|/$||')
          OWNER=$(echo "$REPO_PATH" | cut -d'/' -f1)
          REPO=$(echo "$REPO_PATH" | cut -d'/' -f2)
          
          # Create a safe directory name for storing certification
          CERT_ID=$(echo "$REPO_PATH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "cert_id=$CERT_ID" >> $GITHUB_OUTPUT
          
          echo "Repository: $OWNER/$REPO"
          echo "Certification ID: $CERT_ID"

      - name: Checkout certify repo
        uses: actions/checkout@v4
        with:
          path: certify

      - name: Checkout target project
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo.outputs.repo_path }}
          ref: ${{ inputs.ref }}
          path: target

      # ═══════════════════════════════════════════════════════════════
      # STEP 1: Run Verus Verification
      # ═══════════════════════════════════════════════════════════════
      - name: Run Verus verification
        uses: beneficial-ai-foundation/probe-verus/action@v1
        id: verify
        with:
          project-path: target/${{ inputs.project_path }}
          package: ${{ inputs.package }}
          output-dir: ./output

      - name: Verification summary
        run: |
          echo "## Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ steps.repo.outputs.repo_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ inputs.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verified**: ${{ steps.verify.outputs.verified-count }} / ${{ steps.verify.outputs.total-functions }}" >> $GITHUB_STEP_SUMMARY

      # ═══════════════════════════════════════════════════════════════
      # STEP 2: Certify on Ethereum
      # ═══════════════════════════════════════════════════════════════
      - name: Setup certify environment
        working-directory: certify
        run: |
          # Create certify.conf
          cat > certify.conf << EOF
          CERTIFY_SOURCE="$(realpath ../output/results.json)"
          CERTIFY_DESCRIPTION="BAIF Certification: ${{ steps.repo.outputs.repo_path }}@${{ inputs.ref }} - ${{ steps.verify.outputs.verified-count }}/${{ steps.verify.outputs.total-functions }} verified"
          EOF
          
          cat certify.conf

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install certify dependencies
        working-directory: certify
        run: uv sync

      - name: Certify on ${{ inputs.network }}
        id: certify
        working-directory: certify
        env:
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
          MAINNET_PRIVATE_KEY: ${{ secrets.MAINNET_PRIVATE_KEY }}
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          SEPOLIA_PRIVATE_KEY: ${{ secrets.SEPOLIA_PRIVATE_KEY }}
          CERTIFY_ADDRESS: ${{ inputs.network == 'mainnet' && vars.MAINNET_CERTIFIER_ADDRESS || vars.SEPOLIA_CERTIFIER_ADDRESS }}
        run: |
          NETWORK="${{ inputs.network }}"
          
          # Build command
          CMD="uv run python3 -m certify_cli certify --network $NETWORK"
          
          # Add Safe for mainnet
          if [ "$NETWORK" = "mainnet" ]; then
            CMD="$CMD --safe ${{ vars.MAINNET_SAFE_ADDRESS }} --execute"
          fi
          
          echo "Running: $CMD"
          
          set +e
          OUTPUT=$($CMD 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          # Extract outputs
          # Handle both "Tx Hash: 0x..." and "Tx Hash: ..." (without 0x prefix)
          TX_HASH=$(echo "$OUTPUT" | grep -Eo 'Tx Hash:[[:space:]]*(0x)?[a-fA-F0-9]{64}' | head -1 | sed -E 's/.*Tx Hash:[[:space:]]*(0x)?/0x/')
          CONTENT_HASH=$(echo "$OUTPUT" | grep -Eio 'Content Hash:[[:space:]]*0x[0-9a-fA-F]+' | head -1 | sed -E 's/.*(0x[0-9a-fA-F]+)/\1/')
          
          echo "tx_hash=$TX_HASH" >> $GITHUB_OUTPUT
          echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT
          
          # Build Etherscan URL
          if [ "$NETWORK" = "mainnet" ]; then
            echo "etherscan_url=https://etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
          else
            echo "etherscan_url=https://sepolia.etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
          fi
          
          if [ -z "$TX_HASH" ]; then
            echo "::error::Certification failed - no transaction hash"
            exit 1
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 3: Update Certification Registry
      # ═══════════════════════════════════════════════════════════════
      - name: Update certification registry
        working-directory: certify
        run: |
          uv run python3 -m certify_cli update-registry \
            --cert-id "${{ steps.repo.outputs.cert_id }}" \
            --repo "${{ steps.repo.outputs.repo_path }}" \
            --ref "${{ inputs.ref }}" \
            --network "${{ inputs.network }}" \
            --verified "${{ steps.verify.outputs.verified-count }}" \
            --total "${{ steps.verify.outputs.total-functions }}" \
            --tx-hash "${{ steps.certify.outputs.tx_hash }}" \
            --content-hash "${{ steps.certify.outputs.content_hash }}"
          
          echo "=== Certification files created ==="
          ls -la "certifications/${{ steps.repo.outputs.cert_id }}/"

      - name: Commit certification
        working-directory: certify
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add certifications/
          
          if ! git diff --cached --quiet; then
            git commit -m "cert: ${{ steps.repo.outputs.repo_path }}@${{ inputs.ref }} (${{ steps.verify.outputs.verified-count }}/${{ steps.verify.outputs.total-functions }})"
            git push
            echo "✅ Certification committed"
          else
            echo "No changes to commit"
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 4: Summary
      # ═══════════════════════════════════════════════════════════════
      - name: Final summary
        run: |
          CERT_ID="${{ steps.repo.outputs.cert_id }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Certification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Transaction**: [${{ steps.certify.outputs.tx_hash }}](${{ steps.certify.outputs.etherscan_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Badge for ${{ steps.repo.outputs.repo_path }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "![BAIF Certified](https://raw.githubusercontent.com/Beneficial-AI-Foundation/eth_certify/main/certifications/${CERT_ID}/badge.svg)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add to README (SVG - recommended):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`markdown" >> $GITHUB_STEP_SUMMARY
          echo "[![BAIF Certified](https://raw.githubusercontent.com/Beneficial-AI-Foundation/eth_certify/main/certifications/${CERT_ID}/badge.svg)](https://github.com/Beneficial-AI-Foundation/eth_certify/blob/main/certifications/${CERT_ID}/history.json)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
