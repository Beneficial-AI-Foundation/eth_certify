# Verify External Verus Projects
#
# This workflow verifies that a Verus project's certification is legitimate.
# It performs two levels of verification:
#
# 1. STORED RESULTS VERIFICATION: Verifies that the stored results.json from
#    the certification registry matches the on-chain content hash. This confirms
#    the certification record is authentic.
#
# 2. FRESH VERIFICATION (optional): Re-runs probe-verus on the commit and
#    compares the semantic results (verified count, total functions) with the
#    stored certification. Note: Due to non-deterministic output (timestamps,
#    ordering), the exact hash may differ, but the verification results should match.
#
# Use this to independently verify that a certification is legitimate.

name: Verify Certification

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL (e.g., https://github.com/owner/repo)'
        required: true
        type: string
      commit_id:
        description: 'Git commit SHA to verify (must match the certified commit)'
        required: true
        type: string
      project_path:
        description: 'Path to Verus project within repo (default: . for root)'
        required: false
        default: '.'
        type: string
      package:
        description: 'Package name for workspace projects (optional)'
        required: false
        default: ''
        type: string
      network:
        description: 'Ethereum network to verify against'
        required: false
        default: 'sepolia'
        type: choice
        options:
          - mainnet
          - sepolia

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Parse repository info
        id: repo
        run: |
          REPO_URL="${{ inputs.repo_url }}"
          
          # Extract owner/repo from URL
          # Handles: https://github.com/owner/repo or https://github.com/owner/repo.git
          REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https://github.com/||' | sed 's|\.git$||' | sed 's|/$||')
          OWNER=$(echo "$REPO_PATH" | cut -d'/' -f1)
          REPO=$(echo "$REPO_PATH" | cut -d'/' -f2)
          
          # Create cert_id (same format as certify-external.yml)
          CERT_ID=$(echo "$REPO_PATH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "cert_id=$CERT_ID" >> $GITHUB_OUTPUT
          
          echo "Repository: $OWNER/$REPO"
          echo "Cert ID: $CERT_ID"
          echo "Commit: ${{ inputs.commit_id }}"

      - name: Checkout certify repo
        uses: actions/checkout@v4
        with:
          path: certify

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install certify_cli dependencies
        working-directory: certify
        run: uv sync

      # ═══════════════════════════════════════════════════════════════
      # STEP 1: Look up certification in registry
      # ═══════════════════════════════════════════════════════════════
      - name: Look up certification in registry
        id: lookup
        working-directory: certify
        run: |
          CERT_ID="${{ steps.repo.outputs.cert_id }}"
          COMMIT_ID="${{ inputs.commit_id }}"
          NETWORK="${{ inputs.network }}"
          
          HISTORY_FILE="certifications/${CERT_ID}/history.json"
          
          echo "Looking for certification in: $HISTORY_FILE"
          
          if [ ! -f "$HISTORY_FILE" ]; then
            echo "::error::No certification found for $CERT_ID"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Find certification matching commit_sha and network
          # Use jq to parse the history.json
          CERT=$(cat "$HISTORY_FILE" | jq -r --arg commit "$COMMIT_ID" --arg network "$NETWORK" \
            '.certifications[] | select(.commit_sha == $commit and .network == $network) | @json' | head -1)
          
          if [ -z "$CERT" ] || [ "$CERT" = "null" ]; then
            # Try matching just by commit (for older certifications without network field match)
            CERT=$(cat "$HISTORY_FILE" | jq -r --arg commit "$COMMIT_ID" \
              '.certifications[] | select(.commit_sha == $commit) | @json' | head -1)
          fi
          
          if [ -z "$CERT" ] || [ "$CERT" = "null" ]; then
            echo "::error::No certification found for commit $COMMIT_ID"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Extract fields
          CONTENT_HASH=$(echo "$CERT" | jq -r '.content_hash')
          TX_HASH=$(echo "$CERT" | jq -r '.tx_hash')
          VERIFIED=$(echo "$CERT" | jq -r '.verified')
          TOTAL=$(echo "$CERT" | jq -r '.total')
          RESULTS_FILE=$(echo "$CERT" | jq -r '.results_file // empty')
          VERUS_VERSION=$(echo "$CERT" | jq -r '.verus_version // empty')
          CERT_NETWORK=$(echo "$CERT" | jq -r '.network')
          
          # Merkle sub-hashes (present in newer certifications)
          RESULTS_HASH=$(echo "$CERT" | jq -r '.results_hash // empty')
          SPECS_HASH=$(echo "$CERT" | jq -r '.specs_hash // empty')
          SPECS_FILE=$(echo "$CERT" | jq -r '.specs_file // empty')
          
          echo "found=true" >> $GITHUB_OUTPUT
          echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT
          echo "tx_hash=$TX_HASH" >> $GITHUB_OUTPUT
          echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "results_file=$RESULTS_FILE" >> $GITHUB_OUTPUT
          echo "verus_version=$VERUS_VERSION" >> $GITHUB_OUTPUT
          echo "cert_network=$CERT_NETWORK" >> $GITHUB_OUTPUT
          echo "results_hash=$RESULTS_HASH" >> $GITHUB_OUTPUT
          echo "specs_hash=$SPECS_HASH" >> $GITHUB_OUTPUT
          echo "specs_file=$SPECS_FILE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "═══════════════════════════════════════════════════════════════════"
          echo "                     CERTIFICATION FOUND IN REGISTRY"
          echo "═══════════════════════════════════════════════════════════════════"
          echo "Content Hash:   $CONTENT_HASH"
          echo "TX Hash:        $TX_HASH"
          echo "Verified:       $VERIFIED / $TOTAL"
          echo "Network:        $CERT_NETWORK"
          echo "Verus Version:  $VERUS_VERSION"
          echo "Results File:   $RESULTS_FILE"
          if [ -n "$RESULTS_HASH" ]; then
            echo "Results Hash:   $RESULTS_HASH  (Merkle leaf)"
            echo "Specs Hash:     $SPECS_HASH  (Merkle leaf)"
            echo "Specs File:     $SPECS_FILE"
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 2: Verify stored results hash matches on-chain
      # ═══════════════════════════════════════════════════════════════
      - name: Verify stored results hash
        id: verify-stored-hash
        working-directory: certify
        run: |
          CERT_ID="${{ steps.repo.outputs.cert_id }}"
          RESULTS_FILE="${{ steps.lookup.outputs.results_file }}"
          EXPECTED_HASH="${{ steps.lookup.outputs.content_hash }}"
          
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              VERIFYING STORED RESULTS HASH                       ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          
          # Check if results file exists
          FULL_PATH="certifications/${CERT_ID}/${RESULTS_FILE}"
          if [ -z "$RESULTS_FILE" ] || [ ! -f "$FULL_PATH" ]; then
            echo "::warning::Stored results file not found: $FULL_PATH"
            echo "Skipping stored results verification..."
            echo "stored_verified=skipped" >> $GITHUB_OUTPUT
          else
            # Compute hash of stored results
            COMPUTED_HASH=$(cast keccak < "$FULL_PATH")
            
            echo "Stored results:  $FULL_PATH"
            echo "Computed hash:   $COMPUTED_HASH"
            echo "Expected hash:   $EXPECTED_HASH"
            echo ""
            
            if [ "$COMPUTED_HASH" = "$EXPECTED_HASH" ]; then
              echo "✅ Stored results hash matches certification record!"
              echo "stored_verified=true" >> $GITHUB_OUTPUT
            else
              echo "❌ Hash mismatch!"
              echo "stored_verified=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Verify Merkle structure (specs + results)
        id: verify-merkle
        if: steps.lookup.outputs.results_hash != ''
        working-directory: certify
        run: |
          CERT_ID="${{ steps.repo.outputs.cert_id }}"
          RESULTS_HASH="${{ steps.lookup.outputs.results_hash }}"
          SPECS_HASH="${{ steps.lookup.outputs.specs_hash }}"
          EXPECTED_CONTENT_HASH="${{ steps.lookup.outputs.content_hash }}"
          RESULTS_FILE="${{ steps.lookup.outputs.results_file }}"
          SPECS_FILE="${{ steps.lookup.outputs.specs_file }}"
          
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              VERIFYING MERKLE STRUCTURE                          ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          
          ALL_OK=true
          
          # 1. Verify results file hash matches recorded results_hash
          FULL_RESULTS="certifications/${CERT_ID}/${RESULTS_FILE}"
          if [ -n "$RESULTS_FILE" ] && [ -f "$FULL_RESULTS" ]; then
            COMPUTED_RESULTS_HASH=$(cast keccak < "$FULL_RESULTS")
            echo "Results file:     $FULL_RESULTS"
            echo "Computed hash:    $COMPUTED_RESULTS_HASH"
            echo "Recorded hash:    $RESULTS_HASH"
            if [ "$COMPUTED_RESULTS_HASH" = "$RESULTS_HASH" ]; then
              echo "✅ Results hash matches"
            else
              echo "❌ Results hash mismatch!"
              ALL_OK=false
            fi
          fi
          echo ""
          
          # 2. Verify specs file hash matches recorded specs_hash
          FULL_SPECS="certifications/${CERT_ID}/${SPECS_FILE}"
          if [ -n "$SPECS_FILE" ] && [ -f "$FULL_SPECS" ]; then
            COMPUTED_SPECS_HASH=$(cast keccak < "$FULL_SPECS")
            echo "Specs file:       $FULL_SPECS"
            echo "Computed hash:    $COMPUTED_SPECS_HASH"
            echo "Recorded hash:    $SPECS_HASH"
            if [ "$COMPUTED_SPECS_HASH" = "$SPECS_HASH" ]; then
              echo "✅ Specs hash matches"
            else
              echo "❌ Specs hash mismatch!"
              ALL_OK=false
            fi
          fi
          echo ""
          
          # 3. Verify Merkle root: keccak256(results_hash || specs_hash) == content_hash
          # Concatenate the raw 32-byte hashes (strip 0x prefix) and hash
          COMBINED="${RESULTS_HASH#0x}${SPECS_HASH#0x}"
          COMPUTED_ROOT=$(echo -n "$COMBINED" | xxd -r -p | cast keccak)
          echo "Merkle root check:"
          echo "  keccak256($RESULTS_HASH || $SPECS_HASH)"
          echo "  Computed:  $COMPUTED_ROOT"
          echo "  Expected:  $EXPECTED_CONTENT_HASH"
          if [ "$COMPUTED_ROOT" = "$EXPECTED_CONTENT_HASH" ]; then
            echo "  ✅ Merkle root matches on-chain content hash"
          else
            echo "  ❌ Merkle root mismatch!"
            ALL_OK=false
          fi
          echo ""
          
          if [ "$ALL_OK" = "true" ]; then
            echo "merkle_verified=true" >> $GITHUB_OUTPUT
          else
            echo "merkle_verified=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify on-chain certification
        id: verify-onchain
        working-directory: certify
        env:
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          CERTIFY_ADDRESS: ${{ inputs.network == 'mainnet' && vars.MAINNET_CERTIFIER_ADDRESS || vars.SEPOLIA_CERTIFIER_ADDRESS }}
        run: |
          EXPECTED_HASH="${{ steps.lookup.outputs.content_hash }}"
          NETWORK="${{ steps.lookup.outputs.cert_network }}"
          
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              VERIFYING ON-CHAIN CERTIFICATION                    ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          
          # Build CLI arguments
          CLI_ARGS="$EXPECTED_HASH --network $NETWORK"
          
          if [ "$NETWORK" = "mainnet" ] && [ -n "$MAINNET_RPC_URL" ]; then
            CLI_ARGS="$CLI_ARGS --rpc-url $MAINNET_RPC_URL"
          elif [ "$NETWORK" = "sepolia" ] && [ -n "$SEPOLIA_RPC_URL" ]; then
            CLI_ARGS="$CLI_ARGS --rpc-url $SEPOLIA_RPC_URL"
          fi
          
          if [ -n "$CERTIFY_ADDRESS" ]; then
            CLI_ARGS="$CLI_ARGS --contract $CERTIFY_ADDRESS"
          fi
          
          # Run Python CLI verification
          set +e
          OUTPUT=$(uv run python -m certify_cli verify-hash $CLI_ARGS 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          if [ $EXIT_CODE -eq 0 ] && echo "$OUTPUT" | grep -q "VERIFIED"; then
            echo ""
            echo "✅ On-chain certification verified!"
            echo "onchain_verified=true" >> $GITHUB_OUTPUT
            
            # Extract TX hash from the Transaction line
            TX_HASH=$(echo "$OUTPUT" | grep -Eo 'Transaction:[[:space:]]*https?://[^/]+/tx/(0x[0-9a-fA-F]+)' | grep -Eo '0x[0-9a-fA-F]+')
            if [ -n "$TX_HASH" ]; then
              echo "tx_hash=$TX_HASH" >> $GITHUB_OUTPUT
              if [ "$NETWORK" = "mainnet" ]; then
                echo "etherscan_url=https://etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
              else
                echo "etherscan_url=https://sepolia.etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo ""
            echo "::warning::Certification not found in recent blocks (may be older than 50000 blocks)"
            echo "onchain_verified=skipped" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 3: Re-run Verus verification and compare results
      # ═══════════════════════════════════════════════════════════════
      - name: Checkout target project at specific commit
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo.outputs.repo_path }}
          ref: ${{ inputs.commit_id }}
          path: target

      - name: Verify commit SHA
        working-directory: target
        run: |
          ACTUAL_SHA=$(git rev-parse HEAD)
          EXPECTED_SHA="${{ inputs.commit_id }}"
          
          echo "Expected commit: $EXPECTED_SHA"
          echo "Actual commit:   $ACTUAL_SHA"
          
          # Handle both full and short SHAs
          if [[ ! "$ACTUAL_SHA" == "$EXPECTED_SHA"* ]] && [[ ! "$EXPECTED_SHA" == "$ACTUAL_SHA"* ]]; then
            echo "::error::Commit SHA mismatch!"
            exit 1
          fi
          
          echo "✅ Commit SHA verified"
          echo "full_sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT

      - name: Run fresh Verus verification
        uses: beneficial-ai-foundation/probe-verus/action@v1
        id: fresh-verify
        with:
          project-path: target/${{ inputs.project_path }}
          package: ${{ inputs.package }}
          output-dir: ./output

      - name: Compare verification results
        id: compare
        run: |
          CERTIFIED_VERIFIED="${{ steps.lookup.outputs.verified }}"
          CERTIFIED_TOTAL="${{ steps.lookup.outputs.total }}"
          FRESH_VERIFIED="${{ steps.fresh-verify.outputs.verified-count }}"
          FRESH_TOTAL="${{ steps.fresh-verify.outputs.total-functions }}"
          
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              COMPARING FRESH VS CERTIFIED RESULTS                ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Certified results:  $CERTIFIED_VERIFIED / $CERTIFIED_TOTAL verified"
          echo "Fresh results:      $FRESH_VERIFIED / $FRESH_TOTAL verified"
          echo ""
          
          if [ "$CERTIFIED_VERIFIED" = "$FRESH_VERIFIED" ] && [ "$CERTIFIED_TOTAL" = "$FRESH_TOTAL" ]; then
            echo "✅ Fresh verification matches certified results!"
            echo "results_match=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Results differ from certification"
            echo "   This could indicate code changes or Verus version differences"
            echo "results_match=false" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 4: Summary
      # ═══════════════════════════════════════════════════════════════
      - name: Final summary
        if: always()
        run: |
          echo "## Certification Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Input" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ steps.repo.outputs.repo_path }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ inputs.commit_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Network | ${{ steps.lookup.outputs.cert_network }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Certification Record" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Content Hash | \`${{ steps.lookup.outputs.content_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Certified Results | ${{ steps.lookup.outputs.verified }} / ${{ steps.lookup.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verus Version | ${{ steps.lookup.outputs.verus_version }} |" >> $GITHUB_STEP_SUMMARY
          
          ETHERSCAN_URL="${{ steps.verify-onchain.outputs.etherscan_url }}"
          if [ -n "$ETHERSCAN_URL" ]; then
            echo "| Transaction | [View on Etherscan]($ETHERSCAN_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STORED_VERIFIED="${{ steps.verify-stored-hash.outputs.stored_verified }}"
          ONCHAIN_VERIFIED="${{ steps.verify-onchain.outputs.onchain_verified }}"
          MERKLE_VERIFIED="${{ steps.verify-merkle.outputs.merkle_verified }}"
          RESULTS_MATCH="${{ steps.compare.outputs.results_match }}"
          
          # Stored results check
          if [ "$STORED_VERIFIED" = "true" ]; then
            echo "- ✅ **Stored Results**: Hash matches certification record" >> $GITHUB_STEP_SUMMARY
          elif [ "$STORED_VERIFIED" = "skipped" ]; then
            echo "- ⏭️ **Stored Results**: Skipped (no results file)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **Stored Results**: Hash mismatch!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Merkle structure check (only for newer certifications with specs)
          if [ -n "$MERKLE_VERIFIED" ]; then
            if [ "$MERKLE_VERIFIED" = "true" ]; then
              echo "- ✅ **Merkle Structure**: results_hash + specs_hash → content_hash verified" >> $GITHUB_STEP_SUMMARY
              echo "  - Specs hash: \`${{ steps.lookup.outputs.specs_hash }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **Merkle Structure**: Hash mismatch in Merkle tree!" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # On-chain check
          if [ "$ONCHAIN_VERIFIED" = "true" ]; then
            echo "- ✅ **On-Chain**: Certification found on blockchain" >> $GITHUB_STEP_SUMMARY
          elif [ "$ONCHAIN_VERIFIED" = "skipped" ]; then
            echo "- ⏭️ **On-Chain**: Skipped (certification older than search window)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **On-Chain**: Certification not found!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fresh verification check
          echo "- Fresh Verification: ${{ steps.fresh-verify.outputs.verified-count }} / ${{ steps.fresh-verify.outputs.total-functions }}" >> $GITHUB_STEP_SUMMARY
          if [ "$RESULTS_MATCH" = "true" ]; then
            echo "- ✅ **Results Match**: Fresh run matches certified counts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ **Results Differ**: Fresh run differs from certified (may be Verus version difference)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall verdict
          if [ "$STORED_VERIFIED" = "true" ] || [ "$ONCHAIN_VERIFIED" = "true" ]; then
            if [ "$RESULTS_MATCH" = "true" ]; then
              echo "### ✅ Verification Passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The certification is **authentic** and the code at this commit produces matching verification results." >> $GITHUB_STEP_SUMMARY
            else
              echo "### ⚠️ Verification Partial" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The certification record is **authentic** (matches on-chain), but fresh verification produced different counts." >> $GITHUB_STEP_SUMMARY
              echo "This is likely due to Verus version differences between the original certification and this verification run." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ❌ Verification Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not verify the certification. Check:" >> $GITHUB_STEP_SUMMARY
            echo "- Commit SHA matches a certified commit" >> $GITHUB_STEP_SUMMARY
            echo "- Network setting (mainnet vs sepolia)" >> $GITHUB_STEP_SUMMARY
            echo "- Certification exists in the registry" >> $GITHUB_STEP_SUMMARY
          fi
