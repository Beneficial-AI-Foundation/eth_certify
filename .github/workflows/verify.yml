# Verify External Verus Projects
#
# This workflow verifies that a Verus project's certification is legitimate.
# It performs multiple levels of verification:
#
# 1. STORED RESULTS VERIFICATION: Verifies that the stored results.json from
#    the certification registry matches the on-chain content hash. This confirms
#    the certification record is authentic.
#
# 2. MERKLE STRUCTURE: Verifies that the Merkle tree (results_hash + specs_hash,
#    optionally + proofs_hash) reconstructs the on-chain content hash.
#
# 3. PROOF BUNDLE INTEGRITY (if present): Verifies that all Z3 formula and proof
#    files referenced in proofs.json are present and resolvable in the archived
#    proof bundle.
#
# 4. FRESH VERIFICATION (optional): Re-runs probe-verus on the commit and
#    compares the semantic results (verified count, total functions) with the
#    stored certification. Note: Due to non-deterministic output (timestamps,
#    ordering), the exact hash may differ, but the verification results should match.
#
# Use this to independently verify that a certification is legitimate.

name: Verify Certification

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL (e.g., https://github.com/owner/repo)'
        required: true
        type: string
      commit_id:
        description: 'Git commit SHA to verify (must match the certified commit)'
        required: true
        type: string
      project_path:
        description: 'Path to Verus project within repo (default: . for root)'
        required: false
        default: '.'
        type: string
      package:
        description: 'Package name for workspace projects (optional)'
        required: false
        default: ''
        type: string
      network:
        description: 'Ethereum network to verify against'
        required: false
        default: 'sepolia'
        type: choice
        options:
          - mainnet
          - sepolia

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Parse repository info
        id: repo
        run: |
          REPO_URL="${{ inputs.repo_url }}"
          
          # Extract owner/repo from URL
          # Handles: https://github.com/owner/repo or https://github.com/owner/repo.git
          REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https://github.com/||' | sed 's|\.git$||' | sed 's|/$||')
          OWNER=$(echo "$REPO_PATH" | cut -d'/' -f1)
          REPO=$(echo "$REPO_PATH" | cut -d'/' -f2)
          
          # Create cert_id (same format as certify-external.yml)
          CERT_ID=$(echo "$REPO_PATH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "cert_id=$CERT_ID" >> $GITHUB_OUTPUT
          
          echo "Repository: $OWNER/$REPO"
          echo "Cert ID: $CERT_ID"
          echo "Commit: ${{ inputs.commit_id }}"

      - name: Checkout certify repo
        uses: actions/checkout@v4
        with:
          path: certify

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install certify_cli dependencies
        working-directory: certify
        run: uv sync

      # ═══════════════════════════════════════════════════════════════
      # STEP 1: Verify stored certification (registry, hashes, Merkle,
      #         proof bundle, taxonomy) — all in one Python command
      # ═══════════════════════════════════════════════════════════════
      - name: Verify stored certification
        id: verify-local
        working-directory: certify
        run: |
          CERT_ID="${{ steps.repo.outputs.cert_id }}"
          COMMIT_ID="${{ inputs.commit_id }}"
          NETWORK="${{ inputs.network }}"
          
          OUTPUT=$(uv run python -m certify_cli verify-certification \
            --cert-id "$CERT_ID" \
            --commit "$COMMIT_ID" \
            --network "$NETWORK" \
            --json)
          
          # Validate JSON before parsing
          if ! echo "$OUTPUT" | jq empty 2>/dev/null; then
            echo "::error::verify-certification produced invalid JSON output"
            echo "$OUTPUT"
            exit 1
          fi
          
          # Check if certification was found
          FOUND=$(echo "$OUTPUT" | jq -r '.found')
          if [ "$FOUND" != "true" ]; then
            echo "::error::No certification found for $CERT_ID / $COMMIT_ID"
            exit 1
          fi
          
          # Export values for downstream steps
          echo "content_hash=$(echo "$OUTPUT" | jq -r '.content_hash')" >> $GITHUB_OUTPUT
          echo "tx_hash=$(echo "$OUTPUT" | jq -r '.tx_hash')" >> $GITHUB_OUTPUT
          echo "verified=$(echo "$OUTPUT" | jq -r '.verified')" >> $GITHUB_OUTPUT
          echo "total=$(echo "$OUTPUT" | jq -r '.total')" >> $GITHUB_OUTPUT
          echo "network=$(echo "$OUTPUT" | jq -r '.network')" >> $GITHUB_OUTPUT
          echo "verus_version=$(echo "$OUTPUT" | jq -r '.verus_version')" >> $GITHUB_OUTPUT
          echo "results_hash=$(echo "$OUTPUT" | jq -r '.results_hash')" >> $GITHUB_OUTPUT
          echo "specs_hash=$(echo "$OUTPUT" | jq -r '.specs_hash')" >> $GITHUB_OUTPUT
          echo "proofs_hash=$(echo "$OUTPUT" | jq -r '.proofs_hash')" >> $GITHUB_OUTPUT
          echo "proof_bundle=$(echo "$OUTPUT" | jq -r '.proof_bundle')" >> $GITHUB_OUTPUT
          
          # Check results
          STORED=$(echo "$OUTPUT" | jq -r '.checks.stored_results.status')
          MERKLE=$(echo "$OUTPUT" | jq -r '.checks.merkle_structure.status')
          PROOFS=$(echo "$OUTPUT" | jq -r '.checks.proof_bundle.status')
          TAXONOMY=$(echo "$OUTPUT" | jq -r '.taxonomy_summary // empty')
          
          PROOFS_DETAIL=$(echo "$OUTPUT" | jq -r '.checks.proof_bundle.detail // empty')
          
          echo "stored_results=$STORED" >> $GITHUB_OUTPUT
          echo "merkle_structure=$MERKLE" >> $GITHUB_OUTPUT
          echo "proof_bundle_check=$PROOFS" >> $GITHUB_OUTPUT
          echo "proof_bundle_detail=$PROOFS_DETAIL" >> $GITHUB_OUTPUT
          echo "taxonomy_summary=$TAXONOMY" >> $GITHUB_OUTPUT

      # ═══════════════════════════════════════════════════════════════
      # STEP 2: Verify on-chain certification
      # ═══════════════════════════════════════════════════════════════
      - name: Verify on-chain certification
        id: verify-onchain
        working-directory: certify
        env:
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          CERTIFY_ADDRESS: ${{ inputs.network == 'mainnet' && vars.MAINNET_CERTIFIER_ADDRESS || vars.SEPOLIA_CERTIFIER_ADDRESS }}
        run: |
          EXPECTED_HASH="${{ steps.verify-local.outputs.content_hash }}"
          NETWORK="${{ steps.verify-local.outputs.network }}"
          
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              VERIFYING ON-CHAIN CERTIFICATION                    ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          
          # Build CLI arguments
          CLI_ARGS="$EXPECTED_HASH --network $NETWORK"
          
          if [ "$NETWORK" = "mainnet" ] && [ -n "$MAINNET_RPC_URL" ]; then
            CLI_ARGS="$CLI_ARGS --rpc-url $MAINNET_RPC_URL"
          elif [ "$NETWORK" = "sepolia" ] && [ -n "$SEPOLIA_RPC_URL" ]; then
            CLI_ARGS="$CLI_ARGS --rpc-url $SEPOLIA_RPC_URL"
          fi
          
          if [ -n "$CERTIFY_ADDRESS" ]; then
            CLI_ARGS="$CLI_ARGS --contract $CERTIFY_ADDRESS"
          fi
          
          # Run Python CLI verification
          set +e
          OUTPUT=$(uv run python -m certify_cli verify-hash $CLI_ARGS 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          if [ $EXIT_CODE -eq 0 ] && echo "$OUTPUT" | grep -q "VERIFIED"; then
            echo ""
            echo "✅ On-chain certification verified!"
            echo "onchain_verified=true" >> $GITHUB_OUTPUT
            
            # Extract TX hash from the Transaction line
            TX_HASH=$(echo "$OUTPUT" | grep -Eo 'Transaction:[[:space:]]*https?://[^/]+/tx/(0x[0-9a-fA-F]+)' | grep -Eo '0x[0-9a-fA-F]+')
            if [ -n "$TX_HASH" ]; then
              echo "tx_hash=$TX_HASH" >> $GITHUB_OUTPUT
              if [ "$NETWORK" = "mainnet" ]; then
                echo "etherscan_url=https://etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
              else
                echo "etherscan_url=https://sepolia.etherscan.io/tx/$TX_HASH" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo ""
            echo "::warning::Certification not found in recent blocks (may be older than 50000 blocks)"
            echo "onchain_verified=skipped" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 3: Re-run Verus verification and compare results
      # ═══════════════════════════════════════════════════════════════
      - name: Checkout target project at specific commit
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo.outputs.repo_path }}
          ref: ${{ inputs.commit_id }}
          path: target

      - name: Verify commit SHA
        working-directory: target
        run: |
          ACTUAL_SHA=$(git rev-parse HEAD)
          EXPECTED_SHA="${{ inputs.commit_id }}"
          
          echo "Expected commit: $EXPECTED_SHA"
          echo "Actual commit:   $ACTUAL_SHA"
          
          # Handle both full and short SHAs
          if [[ ! "$ACTUAL_SHA" == "$EXPECTED_SHA"* ]] && [[ ! "$EXPECTED_SHA" == "$ACTUAL_SHA"* ]]; then
            echo "::error::Commit SHA mismatch!"
            exit 1
          fi
          
          echo "✅ Commit SHA verified"
          echo "full_sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT

      - name: Run fresh Verus verification
        uses: beneficial-ai-foundation/probe-verus/action@v1
        id: fresh-verify
        with:
          project-path: target/${{ inputs.project_path }}
          package: ${{ inputs.package }}
          output-dir: ./output

      - name: Compare verification results
        id: compare
        run: |
          CERTIFIED_VERIFIED="${{ steps.verify-local.outputs.verified }}"
          CERTIFIED_TOTAL="${{ steps.verify-local.outputs.total }}"
          FRESH_VERIFIED="${{ steps.fresh-verify.outputs.verified-count }}"
          FRESH_TOTAL="${{ steps.fresh-verify.outputs.total-functions }}"
          
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              COMPARING FRESH VS CERTIFIED RESULTS                ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Certified results:  $CERTIFIED_VERIFIED / $CERTIFIED_TOTAL verified"
          echo "Fresh results:      $FRESH_VERIFIED / $FRESH_TOTAL verified"
          echo ""
          
          if [ "$CERTIFIED_VERIFIED" = "$FRESH_VERIFIED" ] && [ "$CERTIFIED_TOTAL" = "$FRESH_TOTAL" ]; then
            echo "✅ Fresh verification matches certified results!"
            echo "results_match=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Results differ from certification"
            echo "   This could indicate code changes or Verus version differences"
            echo "results_match=false" >> $GITHUB_OUTPUT
          fi

      # ═══════════════════════════════════════════════════════════════
      # STEP 4: Summary
      # ═══════════════════════════════════════════════════════════════
      - name: Final summary
        if: always()
        run: |
          # Read check results from verify-local step
          STORED="${{ steps.verify-local.outputs.stored_results }}"
          MERKLE="${{ steps.verify-local.outputs.merkle_structure }}"
          PROOFS_CHECK="${{ steps.verify-local.outputs.proof_bundle_check }}"
          ONCHAIN_VERIFIED="${{ steps.verify-onchain.outputs.onchain_verified }}"
          RESULTS_MATCH="${{ steps.compare.outputs.results_match }}"
          
          echo "## Certification Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Input" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ steps.repo.outputs.repo_path }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ inputs.commit_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Network | ${{ steps.verify-local.outputs.network }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Certification Record" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Content Hash | \`${{ steps.verify-local.outputs.content_hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Certified Results | ${{ steps.verify-local.outputs.verified }} / ${{ steps.verify-local.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verus Version | ${{ steps.verify-local.outputs.verus_version }} |" >> $GITHUB_STEP_SUMMARY
          
          PROOF_BUNDLE="${{ steps.verify-local.outputs.proof_bundle }}"
          if [ -n "$PROOF_BUNDLE" ]; then
            echo "| Proof Bundle | \`$PROOF_BUNDLE\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          ETHERSCAN_URL="${{ steps.verify-onchain.outputs.etherscan_url }}"
          if [ -n "$ETHERSCAN_URL" ]; then
            echo "| Transaction | [View on Etherscan]($ETHERSCAN_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Stored results check
          if [ "$STORED" = "pass" ]; then
            echo "- ✅ **Stored Results**: Hash matches certification record" >> $GITHUB_STEP_SUMMARY
          elif [ "$STORED" = "skip" ]; then
            echo "- ⏭️ **Stored Results**: Skipped (no results file)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **Stored Results**: Hash mismatch!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Merkle structure check
          if [ "$MERKLE" = "pass" ]; then
            PROOFS_HASH="${{ steps.verify-local.outputs.proofs_hash }}"
            if [ -n "$PROOFS_HASH" ]; then
              echo "- ✅ **Merkle Structure**: results_hash + specs_hash + proofs_hash → content_hash verified" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ✅ **Merkle Structure**: results_hash + specs_hash → content_hash verified" >> $GITHUB_STEP_SUMMARY
            fi
            echo "  - Specs hash: \`${{ steps.verify-local.outputs.specs_hash }}\`" >> $GITHUB_STEP_SUMMARY
            if [ -n "$PROOFS_HASH" ]; then
              echo "  - Proofs hash: \`$PROOFS_HASH\`" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$MERKLE" = "skip" ]; then
            echo "- ⏭️ **Merkle Structure**: Skipped (no Merkle hashes recorded)" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$MERKLE" ]; then
            echo "- ❌ **Merkle Structure**: Hash mismatch in Merkle tree!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Taxonomy
          TAXONOMY_SUMMARY="${{ steps.verify-local.outputs.taxonomy_summary }}"
          if [ -n "$TAXONOMY_SUMMARY" ]; then
            echo "- **Spec Taxonomy**: $TAXONOMY_SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Proof bundle check
          PROOFS_DETAIL="${{ steps.verify-local.outputs.proof_bundle_detail }}"
          if [ "$PROOFS_CHECK" = "pass" ]; then
            if [ -n "$PROOFS_DETAIL" ]; then
              echo "- ✅ **Proof Bundle**: $PROOFS_DETAIL" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ✅ **Proof Bundle**: All referenced files present" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "$PROOFS_CHECK" = "skip" ]; then
            echo "- ⏭️ **Proof Bundle**: Skipped (no proof bundle)" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$PROOFS_CHECK" ]; then
            echo "- ❌ **Proof Bundle**: Integrity check failed (missing files)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # On-chain check
          if [ "$ONCHAIN_VERIFIED" = "true" ]; then
            echo "- ✅ **On-Chain**: Certification found on blockchain" >> $GITHUB_STEP_SUMMARY
          elif [ "$ONCHAIN_VERIFIED" = "skipped" ]; then
            echo "- ⏭️ **On-Chain**: Skipped (certification older than search window)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ **On-Chain**: Certification not found!" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fresh verification check
          echo "- Fresh Verification: ${{ steps.fresh-verify.outputs.verified-count }} / ${{ steps.fresh-verify.outputs.total-functions }}" >> $GITHUB_STEP_SUMMARY
          if [ "$RESULTS_MATCH" = "true" ]; then
            echo "- ✅ **Results Match**: Fresh run matches certified counts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ **Results Differ**: Fresh run differs from certified (may be Verus version difference)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall verdict
          if [ "$STORED" = "pass" ] || [ "$ONCHAIN_VERIFIED" = "true" ]; then
            if [ "$RESULTS_MATCH" = "true" ]; then
              echo "### ✅ Verification Passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The certification is **authentic** and the code at this commit produces matching verification results." >> $GITHUB_STEP_SUMMARY
            else
              echo "### ⚠️ Verification Partial" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The certification record is **authentic** (matches on-chain), but fresh verification produced different counts." >> $GITHUB_STEP_SUMMARY
              echo "This is likely due to Verus version differences between the original certification and this verification run." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ❌ Verification Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not verify the certification. Check:" >> $GITHUB_STEP_SUMMARY
            echo "- Commit SHA matches a certified commit" >> $GITHUB_STEP_SUMMARY
            echo "- Network setting (mainnet vs sepolia)" >> $GITHUB_STEP_SUMMARY
            echo "- Certification exists in the registry" >> $GITHUB_STEP_SUMMARY
          fi
